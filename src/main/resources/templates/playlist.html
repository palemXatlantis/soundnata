<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SoundNata</title>
    <link th:href="@{/main.css}" rel="stylesheet" />
    <link th:href="@{/custom.css}" rel="stylesheet" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="bg-black text-white">

<div class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!--
      Background backdrop, show/hide based on modal state.

      Entering: "ease-out duration-300"
        From: "opacity-0"
        To: "opacity-100"
      Leaving: "ease-in duration-200"
        From: "opacity-100"
        To: "opacity-0"
    -->
    <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!--
              Modal panel, show/hide based on modal state.

              Entering: "ease-out duration-300"
                From: "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                To: "opacity-100 translate-y-0 sm:scale-100"
              Leaving: "ease-in duration-200"
                From: "opacity-100 translate-y-0 sm:scale-100"
                To: "opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            -->
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex size-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:size-10">
                            <svg class="size-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold text-gray-900" id="modal-title">Deactivate account</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">Are you sure you want to deactivate your account? All of your data will be permanently removed. This action cannot be undone.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto">Deactivate</button>
                    <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Include Navigation -->
<div th:replace="fragments/nav::nav"></div>
<div class="flex pt-20 pb-20 h-screen">
    <div th:replace="fragments/aside::aside"></div>

    <main class="flex-1 rounded-lg p-8 space-y-8 overflow-y-auto">
        <section style="padding: 32px; padding-bottom: 16px; padding-left: 16px" class="bg-gray-700 rounded-lg p-8 min-h-screen">
            <div class="flex items-center bg-gray-800 p-4 rounded-lg">
                <img src="/images/question_mark.jpg" alt="Album Art" class="w-48 h-48 rounded-lg mr-6" />
                <div class="flex flex-col ml-6">
                    <h2 class="text- xl font-bold mb-6">Playlist</h2>
                    <h2 id="playlistTitle" class="text-4xl font-bold mb-6" th:text="${playlist.name}">Chill Music</h2>
                    <h2 class="text-xl font-bold mb-1" th:text="${playlist.user.username}">username</h2>
                    <button id="playAllButton" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full mt-4 flex items-center">
                        Play All
                    </button>
                </div>
            </div>

            <div class="mt-6">
                <table class="table-auto w-full">
                    <thead>
                    <tr class="text-left text-white text-sm border-b border-gray-600">
                        <th class="py-3">#</th>
                        <th></th>
                        <th>Title</th>
                        <th>Artist</th>
                        <th>Duration</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="song, iterStat : ${songs}"
                        class="bg-gray-800 hover:bg-gray-700 rounded-lg group"
                        th:data-song-id="${song.id}"
                        th:data-song-url="${song.filePath}"
                        th:data-song-title="${song.title}"
                        th:data-song-artist="${song.artist}"
                        th:data-song-index="${iterStat.index}">
                        <td class="py-3 px-4 text-gray-400" th:text="${iterStat.index + 1}">1</td>
                        <td class="py-3">
                            <div class="flex items-center">
                                <img th:src="${song.imagePath}" alt="Song Cover" class="h-20 rounded-lg mr-4" />
                                <div>
                                    <p class="font-bold text-white" th:text="${song.title}">Song Title</p>
                                    <p class="text-sm text-gray-400" th:text="${song.artist}">Artist</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 text-gray-400" th:text="${song.artist}">Artist</td>
                        <td class="py-3 text-gray-400" th:text="${song.getFormattedDuration()}">Duration</td>
                        <td class="py-3 text-right">
                            <button class="delete-song bg-transparent text-white hover:scale-105 transition-transform px-4 py-1 rounded-full border border-white"
                                    th:onclick="'deleteSongFromPlaylist(' + ${playlist.id} + ',' + ${song.id} + ')'">
                                Delete
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <div class="mt-6 bg-gray-800 p-6 rounded-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Let's find something for your playlist</h2>
            </div>
            <div>
                <input
                        id="playlistSearchInput"
                        type="text"
                        placeholder="Search for songs or artist"
                        class="w-full bg-gray-900 text-white placeholder-gray-400 rounded-lg py-3 px-4 focus:outline-none focus:ring focus:ring-blue-500"
                />
            </div>
            <div id="playlistSearchResults" class="mt-6 hidden">
                <!-- Dynamic search results will be inserted here -->
            </div>
        </div>



    </main>
</div>
<div th:replace="fragments/playback::footer"></div>

<script>
    function formatDuration(seconds) {
        if (!seconds) return '--:--';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    async function deleteSongFromPlaylist(playlistId, songId) {
        if (!confirm('Are you sure you want to remove this song from the playlist?')) {
            return;
        }

        const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        try {
            const response = await fetch(`/playlist/${playlistId}/remove-song/${songId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                }
            });

            if (response.ok) {
                // Refresh the page to show updated playlist
                window.location.reload();
            } else {
                alert('Failed to remove song from playlist');
            }
        } catch (error) {
            console.error('Error removing song:', error);
            alert('Error removing song from playlist');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('playlistSearchInput');
        const searchResults = document.getElementById('playlistSearchResults');

        // Create a container for the search input
        const searchContainer = document.createElement('div');
        searchContainer.className = 'relative';
        searchInput.parentNode.replaceChild(searchContainer, searchInput);
        searchContainer.appendChild(searchInput);

        // Add search icon
        const searchIcon = document.createElement('div');
        searchIcon.className = 'absolute inset-y-0 left-3 flex items-center pointer-events-none';
        searchContainer.insertBefore(searchIcon, searchInput);

        // Update search input styling
        searchInput.className = 'w-full bg-gray-900 text-white placeholder-gray-400 rounded-lg py-3 px-4 pl-10 focus:outline-none';

        let debounceTimeout;

        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }

            debounceTimeout = setTimeout(() => {
                performPlaylistSearch(query);
            }, 300);
        });

        async function performPlaylistSearch(query) {
            try {
                const response = await fetch(`/playlist/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayPlaylistSearchResults(data, searchResults);
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="text-center text-gray-400 py-4">Error performing search</div>';
                searchResults.classList.remove('hidden');
            }
        }
    });

    function displayPlaylistSearchResults(data, searchResults) {
        searchResults.classList.remove('hidden');
        const songs = data.songs || [];
        let resultsHtml = '';

        if (songs.length === 0) {
            resultsHtml = '<div class="text-center text-gray-400 py-4">No results found</div>';
        } else {
            resultsHtml = `
        <div class="space-y-2">
            ${songs.map(song => `
                <div class="flex items-center justify-between p-2 hover:bg-gray-700 rounded-lg group">
                    <div class="flex items-center flex-1">
                        <img src="${song.imagePath || '/images/default-album.jpg'}"
                             alt="${song.title}"
                             class="h-20 rounded object-cover mr-4"/>
                        <div class="flex flex-col">
                            <span class="text-white font-medium">${song.title}</span>
                            <span class="text-gray-400 text-sm">${song.artist}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button
                            class="add-to-playlist bg-transparent text-white hover:scale-105 transition-transform px-4 py-1 rounded-full border border-white"
                            data-song-id="${song.id}">
                            Add
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
        }

        searchResults.innerHTML = resultsHtml;
        initializeAddToPlaylistButtons(searchResults);
    }

    function initializeAddToPlaylistButtons(searchResults) {
        const currentPlaylistId = new URL(window.location.href).pathname.split('/').pop();
        const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        searchResults.querySelectorAll('.add-to-playlist').forEach(button => {
            button.addEventListener('click', async function () {
                const songId = this.dataset.songId;
                try {
                    const response = await fetch(`/playlist/${currentPlaylistId}/add-song/${songId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [header]: token
                        }
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        this.textContent = 'Added';
                        this.disabled = true;
                        this.className = 'text-gray-400 px-4 py-1 rounded-full border border-gray-400 cursor-not-allowed';

                        // Wait a short moment before refreshing to ensure the backend has processed the addition
                        setTimeout(async () => {
                            await refreshPlaylistTable(currentPlaylistId);
                        }, 100);
                    } else {
                        alert('Failed to add song to playlist');
                    }
                } catch (error) {
                    console.error('Error adding song to playlist:', error);
                    alert('Error adding song to playlist');
                }
            });
        });
    }

    async function refreshPlaylistTable(playlistId) {
        try {
            console.log('Refreshing playlist table...');
            const response = await fetch(`/playlist/${playlistId}/songs`);
            if (!response.ok) {
                throw new Error('Failed to fetch updated playlist');
            }
            const songs = await response.json();
            console.log('Received updated songs:', songs);
            updateSongsTable(songs);
        } catch (error) {
            console.error('Error refreshing playlist table:', error);
        }
    }

    function updateSongsTable(songs) {
        const currentPlaylistId = new URL(window.location.href).pathname.split('/').pop();
        const tableBody = document.querySelector('tbody');
        if (!tableBody) {
            console.error('Table body not found');
            return;
        }

        let tableRows = '';

        songs.forEach((song, index) => {
            if (!song) {
                console.error('Invalid song data:', song);
                return;
            }

            tableRows += `
            <tr class="bg-gray-800 hover:bg-gray-700 rounded-lg cursor-pointer group">
                <td class="py-3 px-4 text-gray-400">${index + 1}</td>
                <td class="py-3">
                    <div class="flex items-center">
                        <img src="${song.imagePath || '/images/default-album.jpg'}"
                             alt="Song Cover"
                             class="h-20 rounded-lg mr-4" />
                        <div>
                            <p class="font-bold text-white">${song.title || 'Unknown Title'}</p>
                            <p class="text-sm text-gray-400">${song.artist || 'Unknown Artist'}</p>
                        </div>
                    </div>
                </td>
                <td class="py-3 text-gray-400">${song.artist || 'Unknown Artist'}</td>
                <td class="py-3 text-gray-400">${formatDuration(song.duration) || '--'}</td>
                <td class="py-3 text-right">
                            <button
                                    class="add-to-playlist bg-transparent text-white hover:scale-105 transition-transform px-4 py-1 rounded-full border border-white"
                                    th:onclick="'deleteSongFromPlaylist(' + ${currentPlaylistId} + ',' + ${song.id} + ')'">
                                Delete
                            </button>
                        </td>
            </tr>
        `;
        });

        tableBody.innerHTML = tableRows;
    }
</script>

<script>
    const playlistTitle = document.getElementById('playlistTitle');
    const modal = document.getElementById('editPlaylistModal');
    const form = document.getElementById('editPlaylistForm');
    const nameInput = document.getElementById('playlistName');
    const descriptionInput = document.getElementById('playlistDescription');

    // Add click event to playlist title
    playlistTitle.addEventListener('click', () => {
        openEditPlaylistModal();
    });

    function openEditPlaylistModal() {
        // Get current playlist data
        const currentPlaylistId = new URL(window.location.href).pathname.split('/').pop();
        const currentName = playlistTitle.textContent;

        // Set current values in form
        nameInput.value = currentName;

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeEditPlaylistModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeEditPlaylistModal();
        }
    });

    // Prevent modal close when clicking inside the modal content
    modal.querySelector('.bg-gray-800').addEventListener('click', (e) => {
        e.stopPropagation();
    });

</script>
<script th:src="@{/js/audioPlayer.js}"></script>
<script th:src="@{/js/removeLocalStorage.js}"></script>
</body>
</html>