<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SoundNata</title>
    <link th:href="@{/main.css}" rel="stylesheet" />
    <link th:href="@{/custom.css}" rel="stylesheet" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="bg-black text-white">
<!-- Include Navigation -->
<div th:replace="fragments/nav::nav"></div>
<div class="flex pt-20 pb-20 h-screen">
    <div th:replace="fragments/aside::aside"></div>

    <main class="flex-1 rounded-lg p-8 space-y-8 overflow-y-auto">
        <section style="padding: 32px; padding-bottom: 16px; padding-left: 16px" class="bg-gray-700 rounded-lg p-8 min-h-screen">
            <div class="flex items-center bg-gray-800 p-4 rounded-lg">
                <img src="/images/question_mark.jpg" alt="Album Art" class="w-48 h-48 rounded-lg mr-6" />
                <div class="flex flex-col ml-6">
                    <h2 class="text- xl font-bold mb-6">Playlist</h2>
                    <h2 class="text-4xl font-bold mb-6" th:text="${playlist.name}">Chill Music</h2>
                    <h2 class="text-xl font-bold mb-1" th:text="${playlist.user.username}">username</h2>
                    <button id="playAllButton" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-full mt-4 flex items-center">
                        Play All
                    </button>
                </div>
            </div>

            <div class="mt-6">
                <table class="table-auto w-full">
                    <thead>
                    <tr class="text-center text-white text-sm border-b border-gray-600">
                        <th class="py-3 px-4">#</th>
                        <th class="py-3 px-4">Title</th>
                        <th class="py-3 px-4">Artist</th>
                        <th class="py-3 px-4">Duration</th>
                        <th class="py-3 px-4">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="song, iterStat : ${songs}"
                        class="bg-gray-800 hover:bg-gray-700 rounded-lg group text-center"
                        th:data-song-url="${song.filePath}"
                        th:data-song-title="${song.title}"
                        th:data-song-artist="${song.artist}"
                        th:data-song-index="${iterStat.index}">
                        <td class="py-3 px-4 text-gray-400" th:text="${iterStat.index + 1}">1</td>
                        <td class="py-3 px-4">
                            <div class="flex items-center">
                                <img th:src="${song.imagePath}" alt="Song Cover" class="h-20 rounded-lg mr-4" />
                                <div>
                                    <p class="font-bold text-white text-center" th:text="${song.title}">Song Title</p>
                                    <p class="text-sm text-gray-400 text-center" th:text="${song.artist}">Artist</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-gray-400" th:text="${song.artist}">Artist</td>
                        <td class="py-3 px-4 text-gray-400" th:text="${song.getFormattedDuration()}">Duration</td>
                        <td class="py-3 px-4">
                            <button class="delete-song bg-transparent text-white hover:scale-105 transition-transform px-4 py-1 rounded-full border border-white"
                                    th:onclick="'deleteSongFromPlaylist(' + ${playlist.id} + ',' + ${song.id} + ')'">
                                Delete
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </section>
        <div class="mt-6 bg-gray-800 p-6 rounded-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Let's find something for your playlist</h2>
            </div>
            <div>
                <input
                        id="playlistSearchInput"
                        type="text"
                        placeholder="Search for songs or artist"
                        class="w-full bg-gray-900 text-white placeholder-gray-400 rounded-lg py-3 px-4 focus:outline-none focus:ring focus:ring-blue-500"
                />
            </div>
            <div id="playlistSearchResults" class="mt-6 hidden">
                <!-- Dynamic search results will be inserted here -->
            </div>
        </div>



    </main>
</div>
<div th:replace="fragments/playback::footer"></div>

<script>
    function formatDuration(seconds) {
        if (!seconds) return '--:--';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    async function deleteSongFromPlaylist(playlistId, songId) {
        if (!confirm('Are you sure you want to remove this song from the playlist?')) {
            return;
        }

        const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        try {
            const response = await fetch(`/playlist/${playlistId}/remove-song/${songId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                }
            });

            if (response.ok) {
                // Refresh the page to show updated playlist
                window.location.reload();
            } else {
                alert('Failed to remove song from playlist');
            }
        } catch (error) {
            console.error('Error removing song:', error);
            alert('Error removing song from playlist');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('playlistSearchInput');
        const searchResults = document.getElementById('playlistSearchResults');

        // Create a container for the search input
        const searchContainer = document.createElement('div');
        searchContainer.className = 'relative';
        searchInput.parentNode.replaceChild(searchContainer, searchInput);
        searchContainer.appendChild(searchInput);

        // Add search icon
        const searchIcon = document.createElement('div');
        searchIcon.className = 'absolute inset-y-0 left-3 flex items-center pointer-events-none';
        searchContainer.insertBefore(searchIcon, searchInput);

        // Update search input styling
        searchInput.className = 'w-full bg-gray-900 text-white placeholder-gray-400 rounded-lg py-3 px-4 pl-10 focus:outline-none';

        let debounceTimeout;

        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }

            debounceTimeout = setTimeout(() => {
                performPlaylistSearch(query);
            }, 300);
        });

        async function performPlaylistSearch(query) {
            try {
                const response = await fetch(`/playlist/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayPlaylistSearchResults(data, searchResults);
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="text-center text-gray-400 py-4">Error performing search</div>';
                searchResults.classList.remove('hidden');
            }
        }
    });

    function displayPlaylistSearchResults(data, searchResults) {
        searchResults.classList.remove('hidden');
        const songs = data.songs || [];
        let resultsHtml = '';

        if (songs.length === 0) {
            resultsHtml = '<div class="text-center text-gray-400 py-4">No results found</div>';
        } else {
            resultsHtml = `
        <div class="space-y-2">
            ${songs.map(song => `
                <div class="flex items-center justify-between p-2 hover:bg-gray-700 rounded-lg group">
                    <div class="flex items-center flex-1">
                        <img src="${song.imagePath || '/images/default-album.jpg'}"
                             alt="${song.title}"
                             class="h-20 rounded object-cover mr-4"/>
                        <div class="flex flex-col">
                            <span class="text-white font-medium">${song.title}</span>
                            <span class="text-gray-400 text-sm">${song.artist}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button
                            class="add-to-playlist bg-transparent text-white hover:scale-105 transition-transform px-4 py-1 rounded-full border border-white"
                            data-song-id="${song.id}">
                            Add
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
        }

        searchResults.innerHTML = resultsHtml;
        initializeAddToPlaylistButtons(searchResults);
    }

    function initializeAddToPlaylistButtons(searchResults) {
        const currentPlaylistId = new URL(window.location.href).pathname.split('/').pop();
        const token = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const header = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        searchResults.querySelectorAll('.add-to-playlist').forEach(button => {
            button.addEventListener('click', async function () {
                const songId = this.dataset.songId;
                try {
                    const response = await fetch(`/playlist/${currentPlaylistId}/add-song/${songId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [header]: token
                        }
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        this.textContent = 'Added';
                        this.disabled = true;
                        this.className = 'text-gray-400 px-4 py-1 rounded-full border border-gray-400 cursor-not-allowed';

                        // Wait a short moment before refreshing to ensure the backend has processed the addition
                        setTimeout(async () => {
                            await refreshPlaylistTable(currentPlaylistId);
                        }, 100);
                    } else {
                        alert('Failed to add song to playlist');
                    }
                } catch (error) {
                    console.error('Error adding song to playlist:', error);
                    alert('Error adding song to playlist');
                }
            });
        });
    }

    async function refreshPlaylistTable(playlistId) {
        try {
            console.log('Refreshing playlist table...');
            const response = await fetch(`/playlist/${playlistId}/songs`);
            if (!response.ok) {
                throw new Error('Failed to fetch updated playlist');
            }
            const songs = await response.json();
            console.log('Received updated songs:', songs);
            updateSongsTable(songs);
        } catch (error) {
            console.error('Error refreshing playlist table:', error);
        }
    }

    function updateSongsTable(songs) {
        const currentPlaylistId = new URL(window.location.href).pathname.split('/').pop();
        const tableBody = document.querySelector('tbody');
        if (!tableBody) {
            console.error('Table body not found');
            return;
        }

        let tableRows = '';

        songs.forEach((song, index) => {
            if (!song) {
                console.error('Invalid song data:', song);
                return;
            }

            tableRows += `
            <tr class="bg-gray-800 hover:bg-gray-700 rounded-lg cursor-pointer group">
                <td class="py-3 px-4 text-gray-400">${index + 1}</td>
                <td class="py-3">
                    <div class="flex items-center">
                        <img src="${song.imagePath || '/images/default-album.jpg'}"
                             alt="Song Cover"
                             class="h-20 rounded-lg mr-4" />
                        <div>
                            <p class="font-bold text-white">${song.title || 'Unknown Title'}</p>
                            <p class="text-sm text-gray-400">${song.artist || 'Unknown Artist'}</p>
                        </div>
                    </div>
                </td>
                <td class="py-3 text-gray-400">${song.artist || 'Unknown Artist'}</td>
                <td class="py-3 text-gray-400">${formatDuration(song.duration) || '--'}</td>
                <td class="py-3 text-right">
                            <button
                                    class="add-to-playlist bg-transparent text-white hover:scale-105 transition-transform px-4 py-1 rounded-full border border-white"
                                    th:onclick="'deleteSongFromPlaylist(' + ${currentPlaylistId} + ',' + ${song.id} + ')'">
                                Delete
                            </button>
                        </td>
            </tr>
        `;
        });

        tableBody.innerHTML = tableRows;
    }
</script>
<script th:src="@{/js/audioPlayer.js}"></script>
<script th:src="@{/js/playlist-play.js}"></script>
<script th:src="@{/js/removeLocalStorage.js}"></script>
</body>
</html>